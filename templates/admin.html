<!DOCTYPE html>
<html>
<head>
    <title>Bus Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4">Bus Admin Panel</h1>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm p-4">
                <h3 class="card-title mb-3">Set Route Status</h3>
                <!-- Form -->
                <form id="flag-form">
                    <!-- Route Select -->
                    <div class="mb-3">
                        <label for="route-select" class="form-label">Select Route:</label>
                        <select name="route" id="route-select" class="form-select">
                            {% for route in routes %}
                            <option value="{{ route }}">{{ route }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status Message -->
                    <div class="mb-3">
                        <label for="status-input" class="form-label">Status Message:</label>
                        <input type="text" name="status" id="status-input" class="form-control" placeholder="e.g. Traffic Jam">
                    </div>

                    <!-- Delayed Checkbox -->
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_delayed" id="delayed-check" class="form-check-input" value="true">
                        <label class="form-check-label" for="delayed-check">Mark as Delayed</label>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">Update Status</button>
                        <button type="button" class="btn btn-secondary flex-grow-1" onclick="clearFlag()">Clear Flag</button>
                    </div>
                </form>

                <!-- Result Message -->
                <p id="result-msg" class="mt-3 fw-bold"></p>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <div class="text-center">
        <a href="/dashboard" class="btn btn-outline-primary">Go to Public Dashboard</a>
    </div>
</div>

<!-- Bootstrap JS (optional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Admin JS logic -->
<script>
const form = document.getElementById('flag-form');
const resultMsg = document.getElementById('result-msg');

// Handle "Update Status"
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendFlag(false);
});

// Handle "Clear Flag"
async function clearFlag() {
    document.getElementById('status-input').value = "";
    document.getElementById('delayed-check').checked = false;
    await sendFlag(true); // true = clearing
}

async function sendFlag(isClearing) {
    const formData = new FormData();
    const route = document.getElementById('route-select').value;
    const status = isClearing ? "" : document.getElementById('status-input').value;
    const isDelayed = document.getElementById('delayed-check').checked;

    formData.append('route', route);
    formData.append('status', status);
    formData.append('is_delayed', isDelayed);

    resultMsg.innerText = "Submitting...";
    resultMsg.style.color = "black";

    try {
        const response = await fetch('/admin/flag', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const json = await response.json();
            resultMsg.innerHTML = "✅ Success! " + json.message;
            resultMsg.style.color = "green";
        } else {
            resultMsg.innerText = "❌ Error: Server rejected request.";
            resultMsg.style.color = "red";
        }
    } catch (err) {
        console.error(err);
        resultMsg.innerText = "❌ Error: Could not connect to server.";
        resultMsg.style.color = "red";
    }
}
</script>

</body>
</html>
